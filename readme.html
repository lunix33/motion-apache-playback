<script>
/** @type {HTMLVideoElement} */
let modal;
document.addEventListener('DOMContentLoaded', () => {
  modal = document.querySelector('.modal');

  initTableHeader();
  setupLiveURI();

  document.querySelectorAll('td a').forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      openPlayback(a.href);
    })
  });

  modal.addEventListener('click', closeModal);
  modal.querySelector('.modal-body a.close', closeModal)
});

function initTableHeader() {
  const queryString = location.search;
  let field = 'name';
  let asc = true;

  if (queryString !== '') {
    const urlParams = new Map(
      queryString
        .substring(1)
        .split(';')
        .map(v => v.split('=')));
    const column = urlParams.get('C') || 'N';
    const order = urlParams.get('O') || 'A';
    field =
      (column === 'M') ? 'lastmod' :
      (column === 'S') ? 'size' :
                        'name';
    asc = (order === 'A');
  }

  const headerColumn = document.querySelector(`tr.indexhead th.indexcol${field}`);
  headerColumn.classList.add((asc) ? 'asc' : 'desc');
}

function setupLiveURI() {
  const link = document.querySelector('.liveUri');

  const
    proto = location.protocol,
    host = location.hostname,
    port = parseInt(location.port, 10) - 2;
  const href = `${proto}//${host}:${port}`;

  link.innerText = href;
  link.href = href;
}

function closeModal(event) {
  event.preventDefault();
  if (event.target !== modal && event.target.nodeName !== 'A')
    return;

  modal.classList.add('hidden');
}

function openPlayback(uri) {
  const [cam, time] = fileToData(uri);

  const videoEle = modal.querySelector('video');
  videoEle.src = uri;

  const titleEle = modal.querySelector('h2');
  titleEle.innerText = `${cam}`;

  const timeEle = modal.querySelector('p');
  timeEle.innerText = `${time}`;

  modal.classList.remove('hidden');
}

function fileToData(uri) {
  const rtn = uri
    .substring(
      location.origin.length + 1,
      uri.length - 4)
    .split('_');
  rtn[1] = new Date(
    rtn[1].replace(
      /T(\d{2})-(\d{2})-(\d{2})/g,
      (f, h, m, s) => `T${h}:${m}:${s}`)
    ).toLocaleString('en-ca', {
      dateStyle: 'short',
      timeStyle: 'medium',
      hour12: false
    });

  return rtn;
}
</script>

<div class="modal hidden">
  <div class="modal-body">
    <h2>Title</h2>
    <a class="close" href="#">&times;</a>
    <p>Time</p>
    <video controls></video>
  </div>
</div>
